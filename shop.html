<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vitrine Boutique</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    margin: 0;
    padding: 0;
  }

  .container {
    max-width: 1200px;
    margin: auto;
    padding: 20px;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .header h2 {
    margin: 0;
  }

  #copyLinkBtn, #visitSiteBtn {
    padding: 8px 12px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }

  #copyLinkBtn:hover, #visitSiteBtn:hover {
    background-color: #0056b3;
  }

  .owner {
    font-weight: bold;
    color: #343a40;
    margin-bottom: 10px;
  }

  .site-invite {
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
    gap: 20px;
  }

  .productCard {
    background: #fff;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    transition: transform 0.2s;
  }

  .productCard:hover {
    transform: scale(1.03);
  }

  .productCard img {
    max-width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
  }

  .productCard h4 {
    margin: 5px 0;
    font-size: 1.1em;
    color: #212529;
  }

  .productCard p {
    font-size: 0.9em;
    color: #495057;
  }

  .productCard strong {
    margin-top: 5px;
    color: #007bff;
    font-size: 1em;
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2 id="shopName">Boutique</h2>
    <button id="copyLinkBtn">Copier le lien</button>
  </div>

  <div class="owner" id="shopOwner">Propriétaire: ...</div>

  <div class="site-invite">
    <p>Bienvenue dans notre boutique en ligne ! Découvrez nos produits exclusifs et profitez de nos offres spéciales.</p>
    <button id="visitSiteBtn">Visiter notre site</button>
  </div>

  <div class="products-grid" id="productsContainer"></div>
</div>

<script type="module">
import { supabase } from './supabase.js';

const urlParams = new URLSearchParams(window.location.search);
const shopId = urlParams.get('id');
const shopNameEl = document.getElementById('shopName');
const shopOwnerEl = document.getElementById('shopOwner');
const productsContainer = document.getElementById('productsContainer');
const copyLinkBtn = document.getElementById('copyLinkBtn');
const visitSiteBtn = document.getElementById('visitSiteBtn');

if (!shopId) {
  alert("ID de boutique manquant !");
  throw new Error("ID de boutique manquant");
}

// Copier le lien
copyLinkBtn.onclick = () => {
  navigator.clipboard.writeText(window.location.href)
    .then(() => alert("Lien copié !"))
    .catch(err => alert("Erreur copie lien : " + err));
};

// Redirection site principal
visitSiteBtn.onclick = () => {
  window.location.href = "index.html"; // ou l'URL complet de ton site
};

async function loadShop() {
  // 1️⃣ Récupérer info boutique
  const { data: shop, error } = await supabase
    .from('shops')
    .select('*')
    .eq('id', shopId)
    .single();

  if (error || !shop) {
    productsContainer.innerHTML = "<p style='color:red;'>Boutique introuvable</p>";
    console.error(error);
    return;
  }

  shopNameEl.textContent = shop.name || "Boutique";

  // 2️⃣ Récupérer propriétaire depuis profiles
  let ownerName = "Inconnu";
  if (shop.owner_id) {
    const { data: owner, error: ownerErr } = await supabase
      .from('profiles')
      .select('username')
      .eq('id', shop.owner_id)
      .single();
    if (!ownerErr && owner) ownerName = owner.username;
  }
  shopOwnerEl.textContent = "Propriétaire: " + ownerName;

  // 3️⃣ Récupérer produits
  const { data: products, error: prodError } = await supabase
    .from('shop_products')
    .select('*')
    .eq('shop_id', shopId)
    .order('created_at', { ascending: false });

  if (prodError) {
    productsContainer.innerHTML = "<p style='color:red;'>Erreur chargement produits</p>";
    console.error(prodError);
    return;
  }

  if (!products || products.length === 0) {
    productsContainer.innerHTML = "<p>Aucun produit disponible</p>";
    return;
  }

  products.forEach(p => {
    const div = document.createElement('div');
    div.className = 'productCard';
    div.innerHTML = `
      ${p.image_url ? `<img src="${p.image_url}" alt="${p.name}">` : ""}
      <h4>${p.name}</h4>
      <p>${p.description || ""}</p>
      <strong>${p.price} FCFA</strong>
    `;
    productsContainer.appendChild(div);
  });
}

loadShop();
</script>
</body>
</html>