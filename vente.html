<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Mes Boutiques</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* ===== BODY ===== */
body {
  margin: 0;
  padding: 15px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f4f6f8;
  color: #333;
}

/* ===== HEADER ===== */
header.topbar {
  background: #2e8b57;
  color: #fff;
  padding: 15px 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

header.topbar span#userName {
  font-weight: bold;
  font-size: 16px;
  background: rgba(255,255,255,0.2);
  padding: 8px 12px;
  border-radius: 20px;
}

header.topbar .top-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

header.topbar .top-actions button {
  border: none;
  padding: 8px 18px;
  border-radius: 25px;
  cursor: pointer;
  font-weight: 600;
  color: white;
  transition: 0.2s;
}
#userName{font-size:14px; margin-bottom:8px;background:rgba(255,255,255,0.2);padding:10px 10px;border-radius:20px; height:25px;}
#goToAchat { background: #f39c12; }
#goToAchat:hover { background: #e67e22; }
.logout { background: #c0392b; }
.logout:hover { background: #e74c3c; }

/* ===== BOUTIQUES ===== */
.container {
  display: flex;
  gap: 20px;
  overflow-x: auto;
  padding-bottom: 10px;
  margin-bottom: 20px;
}

.container::-webkit-scrollbar {
  height: 8px;
}
.container::-webkit-scrollbar-thumb {
  background: #2e8b57;
  border-radius: 10px;
}

/* Carte boutique */
.shopCard {
  background: #fff;
  min-width: 220px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  overflow: hidden;
  transition: transform 0.2s, box-shadow 0.2s;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  text-align: center;
}

.shopCard:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.12);
}

.shopCard img {
  width: 100%;
  height: 140px;
  object-fit: cover;
}

.shopCard h4 {
  margin: 10px 0 5px;
  font-size: 18px;
}

.shopCard small {
  color: #777;
  margin-bottom: 10px;
}

.shopCard button {
  margin: 10px;
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: #2e8b57;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

.shopCard button:hover { background: #27ae60; }

/* ===== MODAL ===== */
#shopFullModal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  z-index: 1000;
  overflow-y: auto;
  padding: 30px 15px;
}

#shopFullModal .modal-content {
  background: #fff;
  border-radius: 12px;
  max-width: 600px;
  margin: auto;
  padding: 20px;
  position: relative;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
}

#shopFullModal span#closeShopFullModal {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  color: #333;
}

#shopFullModal input, #shopFullModal textarea {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1em;
}

#shopFullModal button.addBtn {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 8px;
  border: none;
  background: #2e8b57;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

#shopFullModal button.addBtn:hover {
  background: #27ae60;
}

/* ===== PRODUITS DANS BOUTIQUE ===== */
#productsContainer {
  display: flex;
  gap: 15px;
  overflow-x: auto;
  padding: 10px 0;
}

#productsContainer::-webkit-scrollbar {
  height: 6px;
}

#productsContainer::-webkit-scrollbar-thumb {
  background: #2e8b57;
  border-radius: 10px;
}

.productCard {
  background: #fff;
  min-width: 180px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  overflow: hidden;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding: 10px;
  transition: transform 0.2s, box-shadow 0.2s;
}

.productCard:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.12);
}

.productCard img {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 10px;
}

/* Responsive */
@media (max-width:600px) {
  .shopCard, .productCard { min-width: 150px; }
  header.topbar span#userName { font-size: 14px; }
}
  #createShopBtn{background:#4caf50; width:200px; border-radius:20px; color:#fff; font-size: 15px; height:50px;}
  
  /* Bouton header Premium */
.premiumHeaderBtn {
  background: #f39c12;
  color: white;
  border: none;
  padding: 8px 18px;
  border-radius: 25px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}

.premiumHeaderBtn:hover {
  background: #e67e22;
}

/* ===== SIDEBAR PREMIUM ===== */
#premiumSidebar {
  position: fixed;
  top: 0; right: -400px;
  width: 350px;
  height: 100%;
  background: #fff;
  box-shadow: -4px 0 12px rgba(0,0,0,0.2);
  padding: 20px;
  transition: right 0.3s ease-in-out;
  z-index: 2000;
  overflow-y: auto;
}

#premiumSidebar.active {
  right: 0;
}

#premiumSidebar span#closePremiumSidebar {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 28px;
  cursor: pointer;
  color: #333;
}

.premium-cards {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: 20px;
}

.premium-card {
  background: #f4f6f8;
  padding: 15px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.premium-card h4 {
  margin-bottom: 8px;
  color: #2e8b57;
}

.premium-card p {
  font-size: 14px;
  color: #555;
  margin-bottom: 10px;
}

.premium-card button {
  background: #2e8b57;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  width: 100%;
  font-weight: bold;
  transition: 0.2s;
}

.premium-card button:hover {
  background: #27ae60;
}

/* Responsive */
@media(max-width:600px){
  #premiumSidebar { width: 90%; }
}
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="topbar">
  <span id="userName">Connect√© : NomUtilisateur</span>
  <div class="top-actions">
    <button id="goToAchat">Acheter</button>
    <button id="premiumMenuBtn" class="premiumHeaderBtn">Premium</button>
    <button class="logout" id="logoutBtn">D√©connexion</button>
  </div>
</header>

  <!-- ===== SIDEBAR PREMIUM ===== -->
<div id="premiumSidebar">
  <span id="closePremiumSidebar">&times;</span>
  <h3>üöÄ Devenir Premium</h3>
  <p>Augmentez la visibilit√© de votre boutique et vos ventes !</p>

  <div class="premium-cards">
    <div class="premium-card" data-level="premium1" data-price="1000">
      <h4>Premium 1 ‚≠ê</h4>
      <p>Jusqu'√† 20 produits<br>Boutique affich√©e plus haut</p>
      <button class="premiumBtn">Payer 1 000 FCFA / mois</button>
    </div>
    <div class="premium-card" data-level="premium2" data-price="2000">
      <h4>Premium 2 ‚≠ê‚≠ê</h4>
      <p>Jusqu'√† 30 produits<br>Boutique prioritaire</p>
      <button class="premiumBtn">Payer 2 000 FCFA / mois</button>
    </div>
    <div class="premium-card" data-level="premium3" data-price="3000">
      <h4>Premium 3 ‚≠ê‚≠ê‚≠ê</h4>
      <p>Nombre illimit√© de produits<br>Boutique toujours en haut</p>
      <button class="premiumBtn">Payer 3 000 FCFA / mois</button>
    </div>
  </div>
</div>
<!-- ===== MES BOUTIQUES ===== -->
<h3>Mes boutiques</h3>
<div class="container" id="myShops"></div>
<button id="createShopBtn" class="addBtn">üè™ Prendre une boutique</button>

<!-- ===== MODAL BOUTIQUE + PRODUITS ===== -->
<div id="shopFullModal">
  <div class="modal-content">
    <span id="closeShopFullModal">&times;</span>

    <!-- Cr√©er une boutique -->
    <div id="createShopSection">
      <h3>Cr√©er une boutique</h3>
      <input id="shopName" placeholder="Nom de la boutique">
      <textarea id="shopDesc" placeholder="Description"></textarea>
      <input id="shopCategory" placeholder="Cat√©gorie (ex : Fruits, C√©r√©ales)">
      <input id="shopLocation" placeholder="Localisation">
      <input type="file" id="shopImage" accept="image/*">
      <button id="submitShopBtn" class="addBtn">Cr√©er la boutique</button>
    </div>

    <!-- Ajouter produits √† une boutique -->
    <div id="shopProductsSection" style="display:none; margin-top:20px;">
      <h3 id="shopProductsTitle">Boutique</h3>
      <div id="addProductForm">
        <input id="productName" placeholder="Nom du produit">
        <textarea id="productDesc" placeholder="Description"></textarea>
        <input id="productPrice" placeholder="Prix en FCFA" type="number">
        <input type="file" id="productImage" accept="image/*">
        <button id="submitProductBtn" class="addBtn">Ajouter le produit</button>
      </div>
      <div id="productsContainer"></div>
    </div>

  </div>
</div>

<script type="module">
import { supabase } from './supabase.js';

let currentUser = null;
let currentProfile = null;
let currentShop = null;

// ===== ELEMENTS DOM =====
const myShopsContainer = document.getElementById("myShops");
document.addEventListener('DOMContentLoaded', () => {
  const shopFullModal = document.getElementById('shopFullModal');
  const closeBtn = document.getElementById('closeShopFullModal');

  if (!shopFullModal || !closeBtn) {
    console.error("‚ùå Modal ou bouton fermer introuvable");
    return;
  }

  // Clique sur X
  closeBtn.addEventListener('click', () => {
    shopFullModal.style.display = "none";
  });

  // Optionnel : fermer si on clique √† l‚Äôext√©rieur du modal
  window.addEventListener('click', (e) => {
    if (e.target === shopFullModal) {
      shopFullModal.style.display = "none";
    }
  });
});
  document.getElementById('createShopBtn').onclick = () => {
  shopFullModal.style.display = "block";
  createShopSection.style.display = "block";
  shopProductsSection.style.display = "none";
};
const createShopSection = document.getElementById("createShopSection");
const shopProductsSection = document.getElementById("shopProductsSection");
const shopProductsTitle = document.getElementById("shopProductsTitle");

const shopName = document.getElementById("shopName");
const shopDesc = document.getElementById("shopDesc");
const shopCategory = document.getElementById("shopCategory");
const shopLocation = document.getElementById("shopLocation");
const shopImage = document.getElementById("shopImage");
const submitShopBtn = document.getElementById("submitShopBtn");

const productName = document.getElementById("productName");
const productDesc = document.getElementById("productDesc");
const productPrice = document.getElementById("productPrice");
const productImage = document.getElementById("productImage");
const submitProductBtn = document.getElementById("submitProductBtn");

const userNameEl = document.getElementById('userName');

// ===== LIMITES PRODUITS SELON PREMIUM =====
const shopProductLimits = {
  free: 10,
  premium1: 20,
  premium2: 30,
  premium3: Infinity
};

// ===== LOGIN & PROFIL =====
async function loadCurrentUser() {
  const { data: { user }, error } = await supabase.auth.getUser();
  if (error || !user) {
    location.href = "login.html";
    return;
  }
  currentUser = user;

  // R√©cup√©rer profil
  const { data: profiles } = await supabase
    .from("profiles")
    .select('*')
    .eq('id', currentUser.id);

  if (profiles.length) {
    currentProfile = profiles[0];

    // üîπ V√©rifier expiration premium (30 jours)
    if (currentProfile.premium_start) {
      const start = new Date(currentProfile.premium_start);
      const now = new Date();
      const diffDays = Math.floor((now - start) / (1000 * 60 * 60 * 24));
      if (diffDays >= 30) {
        // Expiration
        await supabase.from('profiles').update({
          premium_level: 'free',
          premium_start: null
        }).eq('id', currentUser.id);
        currentProfile.premium_level = 'free';
      }
    }
  }

  renderUserIdentity();
  loadMyShops();
}

// ===== AFFICHAGE EMAIL + BADGES PREMIUM =====
function renderUserIdentity() {
  let stars = "";
  switch(currentProfile?.premium_level) {
    case "premium1": stars = "‚≠ê"; break;
    case "premium2": stars = "‚≠ê‚≠ê"; break;
    case "premium3": stars = "‚≠ê‚≠ê‚≠ê"; break;
  }

  userNameEl.innerHTML = `
    ${currentProfile?.username || currentUser.email}
    <span style="color:gold">${stars}</span>
  `;
}
 // Bouton logout
  document.getElementById('logoutBtn').onclick = async () => {
    await supabase.auth.signOut();
    location.href = 'login.html';
  };
   // Redirection du bouton "Acheter"
  document.getElementById('goToAchat').addEventListener('click', () => {
    window.location.href = 'index.html';
  });
// ===== CREER BOUTIQUE =====
submitShopBtn.onclick = async () => {
  const name = shopName.value.trim();
  if (!name) { alert("Nom obligatoire"); return; }

  let imageUrl = null;
  const file = shopImage.files[0];
if (file) {
  const compressedFile = await compressImage(file, 900, 0.7);
  const fileName = `shop_${currentUser.id}_${Date.now()}.jpg`;

  await supabase.storage
    .from("shops")
    .upload(fileName, compressedFile, {
      contentType: "image/jpeg"
    });

  imageUrl = supabase.storage
    .from("shops")
    .getPublicUrl(fileName).data.publicUrl;
}

  const { error } = await supabase.from("shops").insert({
    owner_id: currentUser.id,
    name,
    description: shopDesc.value,
    category: shopCategory.value,
    location: shopLocation.value,
    image_url: imageUrl,
    premium_level: currentProfile?.premium_level || 'free'
  });

  if(error){ alert(error.message); return; }

  // Reset form
  shopName.value = "";
  shopDesc.value = "";
  shopCategory.value = "";
  shopLocation.value = "";
  shopImage.value = "";

  shopFullModal.style.display = "none";
  loadMyShops();
};

  // ====== BOUTON PREMIUM / SIDEBAR ======
document.addEventListener('DOMContentLoaded', async () => {
  const premiumMenuBtn = document.getElementById('premiumMenuBtn');
  const closePremiumSidebar = document.getElementById('closePremiumSidebar');
  const premiumSidebar = document.getElementById('premiumSidebar');
  const userNameEl = document.getElementById('userName'); // pour mettre √† jour les √©toiles apr√®s paiement

  if (!premiumMenuBtn || !closePremiumSidebar || !premiumSidebar || !userNameEl) {
    console.error("‚ùå √âl√©ments Premium manquants");
    return;
  }

  // Ouvrir sidebar
  premiumMenuBtn.addEventListener('click', () => {
    premiumSidebar.classList.add('active');
  });

  // Fermer sidebar
  closePremiumSidebar.addEventListener('click', () => {
    premiumSidebar.classList.remove('active');
  });

  // ===== CLIQUE SUR LES BOUTONS PREMIUM =====
  document.querySelectorAll('.premiumBtn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const card = e.target.closest('.premium-card');
      if (!card) return;

      const level = card.dataset.level; // premium1, premium2, premium3
      const price = card.dataset.price; // prix √† afficher

      if (!confirm(`Voulez-vous payer ${price} FCFA pour devenir ${level} ?`)) return;

      // ===== API DE PAIEMENT =====
      // TODO : remplacer par l'appel r√©el √† l'API MoMo / MTN / Moov / Celtis
      console.log(`Simulation paiement: ${price} FCFA pour ${level}`);
      // await initPaymentAPI(level, price); // √† ins√©rer ici

      // ===== MISE √Ä JOUR SUPABASE =====
      try {
        const { data, error } = await supabase.from('profiles').update({
          premium_level: level,
          premium_start: new Date() // date de d√©but du Premium
        }).eq('id', currentUser.id);

        if (error) {
          alert("Erreur activation premium : " + error.message);
          return;
        }

        alert(`üéâ F√©licitations ! Vous √™tes maintenant ${level}`);

        // Mettre √† jour le badge √©toiles dans l'UI
        let stars = '';
        switch(level){
          case 'premium1': stars = '‚≠ê'; break;
          case 'premium2': stars = '‚≠ê‚≠ê'; break;
          case 'premium3': stars = '‚≠ê‚≠ê‚≠ê'; break;
        }
        userNameEl.innerHTML = (currentProfile?.username || currentUser.email) + `<span style="color:gold">${stars}</span>`;

        premiumSidebar.classList.remove('active'); // fermer sidebar
      } catch(err){
        console.error("Erreur activation premium:", err);
        alert("Erreur lors de l'activation du premium.");
      }
    });
  });
});
  
  // ===== COMPRESSION IMAGE AVANT UPLOAD =====
async function compressImage(file, maxWidth = 800, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = e => img.src = e.target.result;
    reader.onerror = reject;

    img.onload = () => {
      const canvas = document.createElement("canvas");
      const scale = maxWidth / img.width;
      canvas.width = maxWidth;
      canvas.height = img.height * scale;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(
        blob => resolve(blob),
        "image/jpeg",
        quality
      );
    };

    reader.readAsDataURL(file);
  });
}
// ===== CHARGER MES BOUTIQUES =====
async function loadMyShops() {
  if (!currentUser) return;

  const { data: shops, error } = await supabase
    .from("shops")
    .select("*")
    .eq("owner_id", currentUser.id)
    .order("created_at", { ascending: false });

  myShopsContainer.innerHTML = "";

  if (error) {
    console.error("‚ùå Erreur chargement boutiques :", error);
    myShopsContainer.innerHTML = "<p style='color:red;'>Erreur chargement boutiques</p>";
    return;
  }

  if (!shops || shops.length === 0) {
    myShopsContainer.innerHTML = "<p>Aucune boutique</p>";
    return;
  }

  shops.forEach(shop => {
    const div = document.createElement("div");
    div.className = "shopCard";

    // ‚≠ê Badge premium
    let stars = "";
    if (shop.premium_level === "premium1") stars = "‚≠ê";
    if (shop.premium_level === "premium2") stars = "‚≠ê‚≠ê";
    if (shop.premium_level === "premium3") stars = "‚≠ê‚≠ê‚≠ê";

    div.innerHTML = `
      ${shop.image_url ? `<img src="${shop.image_url}" alt="${shop.name}">` : ""}

      <h4>
        ${shop.name}
        <span style="color:gold;">${stars}</span>
      </h4>

      <small>${shop.category || ""}</small>

      <div style="display:flex; flex-direction:column; gap:6px; margin-top:5px;">
        <button class="openShopBtn addBtn">Ouvrir</button>

        <button class="publicBtn" style="background:#2196F3;color:#fff;">
          Voir vitrine
        </button>

        <button class="deleteShopBtn" style="background:#e53935;color:#fff;">
          Supprimer
        </button>
      </div>
    `;

    /* ===== OUVRIR BOUTIQUE ===== */
    div.querySelector(".openShopBtn").onclick = () => {
      openShop(shop);
    };

    /* ===== VITRINE PUBLIQUE ===== */
    div.querySelector(".publicBtn").onclick = () => {
      window.open(`shop.html?id=${shop.id}`, "_blank");
    };

    /* ===== SUPPRIMER BOUTIQUE (DB + STORAGE) ===== */
    div.querySelector(".deleteShopBtn").onclick = async () => {
      if (!confirm("‚ö†Ô∏è Supprimer cette boutique et tous ses produits ?")) return;

      try {
        /* üî• 1. R√©cup√©rer les produits */
        const { data: products } = await supabase
          .from("shop_products")
          .select("image_url")
          .eq("shop_id", shop.id);

        /* üî• 2. Supprimer images produits */
        if (products && products.length > 0) {
          const productFiles = products
            .filter(p => p.image_url)
            .map(p => p.image_url.split("/").pop());

          if (productFiles.length > 0) {
            await supabase.storage
              .from("products")
              .remove(productFiles);
          }
        }

        /* üî• 3. Supprimer image boutique */
        if (shop.image_url) {
          const shopFile = shop.image_url.split("/").pop();
          await supabase.storage
            .from("shops")
            .remove([shopFile]);
        }

        /* üî• 4. Supprimer produits en DB */
        await supabase
          .from("shop_products")
          .delete()
          .eq("shop_id", shop.id);

        /* üî• 5. Supprimer boutique */
        const { error: deleteError } = await supabase
          .from("shops")
          .delete()
          .eq("id", shop.id);

        if (deleteError) {
          console.error(deleteError);
          alert("Erreur suppression boutique");
          return;
        }

        alert("‚úÖ Boutique supprim√©e (images incluses)");
        loadMyShops();

      } catch (err) {
        console.error("‚ùå Erreur suppression compl√®te :", err);
        alert("Erreur inattendue lors de la suppression");
      }
    };

    myShopsContainer.appendChild(div);
  });
}
// ===== OUVRIR BOUTIQUE =====
async function openShop(shop){
  if (!shop) return;
  currentShop = shop;

  shopFullModal.style.display = "block";
  createShopSection.style.display = "none";
  shopProductsSection.style.display = "block";
  shopProductsTitle.textContent = "Boutique : " + shop.name;

  await loadShopProducts(shop.id);
}

// ===== CHARGER PRODUITS BOUTIQUE =====
async function loadShopProducts(shopId) {
  const productsContainer = document.getElementById("productsContainer");
  if (!productsContainer || !shopId) return;

  productsContainer.innerHTML = "";

  const { data: products, error } = await supabase
    .from("shop_products")
    .select("*")
    .eq("shop_id", shopId)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("‚ùå Erreur chargement produits :", error);
    productsContainer.innerHTML =
      "<p style='color:red;'>Erreur chargement produits</p>";
    return;
  }

  if (!products || products.length === 0) {
    productsContainer.innerHTML = "<p>Aucun produit disponible</p>";
    return;
  }

  products.forEach(product => {
    const div = document.createElement("div");
    div.className = "productCard";

    div.innerHTML = `
      ${product.image_url ? `<img src="${product.image_url}" alt="${product.name}">` : ""}

      <h4>${product.name}</h4>
      <p>${product.description || ""}</p>
      <strong>${product.price} FCFA</strong>

      <div style="margin-top:8px; display:flex; flex-direction:column; gap:6px;">
        <button class="deleteProductBtn" style="background:#e53935;color:#fff;">
          Supprimer
        </button>
      </div>
    `;

    /* ===== SUPPRIMER PRODUIT ===== */
    div.querySelector(".deleteProductBtn").onclick = async () => {
      if (!confirm("‚ö†Ô∏è Supprimer ce produit ?")) return;

      const { error: deleteError } = await supabase
        .from("shop_products")
        .delete()
        .eq("id", product.id);

      if (deleteError) {
        alert("Erreur suppression produit");
        console.error(deleteError);
        return;
      }

      alert("‚úÖ Produit supprim√©");
      loadShopProducts(shopId); // recharger la liste
    };

    productsContainer.appendChild(div);
  });
}

// ===== AJOUT PRODUIT BOUTIQUE =====
submitProductBtn.onclick = async () => {
  if (!currentShop) { alert("S√©lectionnez d'abord une boutique"); return; }

  const name = productName.value.trim();
  const desc = productDesc.value.trim();
  const price = Number(productPrice.value);
  const file = productImage.files[0];

  if (!name || !price) { alert("Nom et prix obligatoires"); return; }

  // V√©rifier limite produits selon premium
  const { data: shop } = await supabase.from('shops')
    .select('premium_level')
    .eq('id', currentShop.id)
    .single();

  const { data: products } = await supabase.from('shop_products')
    .select('id')
    .eq('shop_id', currentShop.id);

  const maxProducts = shopProductLimits[shop.premium_level || 'free'];
  if (products.length >= maxProducts) { 
    alert(`Vous avez atteint le nombre maximum de produits (${maxProducts}) pour votre niveau !`);
    return; 
  }

  // Upload image
  let imageUrl = null;
  if (file) {
  const compressedFile = await compressImage(file, 800, 0.7);
  const fileName = `product_${currentShop.id}_${Date.now()}.jpg`;

  await supabase.storage
    .from("products")
    .upload(fileName, compressedFile, {
      contentType: "image/jpeg"
    });

  imageUrl = supabase.storage
    .from("products")
    .getPublicUrl(fileName).data.publicUrl;
}

  await supabase.from('shop_products').insert({
    shop_id: currentShop.id,
    name,
    description: desc,
    price,
    image_url: imageUrl
  });

  // Reset form
  productName.value = "";
  productDesc.value = "";
  productPrice.value = "";
  productImage.value = "";

  await loadShopProducts(currentShop.id);
};

// ===== INIT =====
await loadCurrentUser();
</script>
  </body>
</html>